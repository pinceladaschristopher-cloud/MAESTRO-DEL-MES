<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro del Mes</title>
    <!-- Fuentes personalizadas para el logo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chewy&family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración para usar la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        chewy: ['Chewy', 'cursive'],
                        montserrat: ['Montserrat', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs (v8 para compatibilidad con iframes) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Estilos personalizados minimalistas, compactos y horizontales -->
    <style>
        /* --- TEMA Y PALETA DE COLORES (PROPORCIONADOS) --- */
        :root {
            --logo-blue: #1A2C59; 
            --logo-red: #E02B20; 
        }

        body {
            background-color: white; 
            font-family: 'Inter', sans-serif;
            min-height: 100vh; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem; 
        }
        
        /* --- ESTILOS DEL LOGO --- */
        .logo-link {
            text-decoration: none;
            color: inherit;
            cursor: default; /* El cursor de agarre se aplica al wrapper de imagen en modo admin */
            display: inline-block; 
        }
        .text-colegio {
            color: var(--logo-blue); 
            font-family: 'Montserrat', sans-serif; 
            font-size: clamp(1rem, 3vw, 1.2rem); 
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: -8px; 
        }
        .text-pinceladas {
            font-family: 'Chewy', cursive; 
            color: var(--logo-red); 
            font-size: clamp(2.5rem, 8vw, 3.5rem);
            line-height: 1;
        }
        .text-calificaciones {
            background-color: var(--logo-blue); 
            color: #ffffff; 
            padding: 4px 6px; 
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif; 
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-weight: 700;
            display: flex; 
            justify-content: center;
            align-items: center;
            margin-top: -3px; 
            letter-spacing: 2px;
            box-sizing: border-box;
            text-align: center;
            width: auto; 
        }

        /* --- ESPACIO LIBRE DESPUÉS DEL LOGO --- */
        header {
            margin-bottom: 8vh; 
        }

        /* --- ESTILOS DE TARJETAS (COMPACTAS Y ESCALONADAS) --- */
        .card-container {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: default; /* Eliminado cursor: pointer de la tarjeta */
            width: 18%; 
            height: auto; 
            flex-shrink: 0; 
            margin-bottom: 0; 
            padding: 0.6rem; 
            border-radius: 1rem; 
        }
        .card-container:hover {
            /* Mantenemos el efecto visual de elevación */
            transform: translateY(-3px);
            box-shadow: 0 12px 25px -5px rgba(0, 0, 0, 0.2); 
        }

        /* Contenedor del Placeholder y la Imagen */
        .image-placeholder-wrapper {
            width: 100%;
            height: 220px; /* ALTURA COMPACTADA */
            aspect-ratio: 4/5; 
            background-color: #d4d8de; /* Fondo gris para COMING SOON */
            border-radius: 0.75rem; 
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden; /* CRUCIAL para el recorte de imagen */
            cursor: default; 
        }
        .admin-mode-drag {
            cursor: grab;
            touch-action: none; /* Previene el scroll mientras se arrastra */
        }
        .coming-soon-text {
            font-size: 1.4rem; 
            font-weight: bold;
            color: #5c5c5c;
            text-align: center;
            z-index: 10;
        }
        .actual-image {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 0.75rem;
            
            /* Propiedades CSS para la edición total */
            transform-origin: top left; /* El origen de la transformación es la esquina superior izquierda */
            transform: scale(1) translate(0px, 0px); /* Usar translate(X, Y) */
        }

        /* Estilo para el slider de zoom */
        .zoom-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        .zoom-slider:hover {
            opacity: 1;
        }
        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--logo-blue);
            cursor: pointer;
        }
        
        /* Layout Horizontal para Escritorio (Desktop First) */
        #cards-container {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            justify-content: center; 
            align-items: flex-start; 
            gap: 0.5rem; /* Separación horizontal */
            padding-top: 0; 
            padding-bottom: 0;
        }

        /* Reglas de Desplazamiento Vertical ESCALABLE (vh) */
        #card-Secundaria_Primer_Ciclo { margin-top: 0; }
        #card-Primaria_Primer_Ciclo, #card-Primaria_Segundo_Ciclo { margin-top: 3vh; }
        #card-Inicial_Primer_Ciclo, #card-Inicial_Segundo_Ciclo { margin-top: 6vh; }

        /* Responsive para Móviles y Tablets */
        @media (max-width: 1024px) {
            header { margin-bottom: 1rem; }
            #cards-container {
                flex-wrap: wrap; 
                padding-top: 1rem; 
                gap: 1rem; 
            }
            .card-container {
                width: 48%; 
                height: auto; 
                margin-bottom: 1rem;
                margin-top: 0 !important;
                padding: 0.5rem; 
            }
            .image-placeholder-wrapper { height: 160px; } /* Altura compactada para móvil */
        }
    </style>
</head>
<body>

    <header class="text-center py-4 w-full max-w-7xl relative">
        <!-- LOGO (NUEVO ENCABEZADO) -->
        <div class="bg-white flex flex-col justify-center items-center text-center">
            <!-- El 'a' con onClick es el nuevo botón de acceso al Modo Edición -->
            <a href="#" class="logo-link" onclick="toggleAdminMode(); return false;">
                <div class="logo-container">
                    <div class="text-section">
                        <!-- Estructura del logo exactamente como se solicitó -->
                        <div class="text-colegio">COLEGIO</div>
                        <div class="text-pinceladas">Pinceladas</div>
                        <div class="text-calificaciones">MAESTRO DEL MES</div>
                    </div>
                </div>
            </a>
        </div>
    </header>

    <main class="w-full max-w-7xl mx-auto px-2 pb-6 flex-grow flex justify-center items-start">
        <!-- Contenedor responsivo para las tarjetas -->
        <div id="cards-container">
            <!-- Las tarjetas se inicializarán y poblarán con datos de Firestore aquí -->
        </div>
    </main>
    
    <!-- Mensajes y Status -->
    <footer class="w-full max-w-7xl text-center py-4">
        <div id="error-message" class="text-center mt-2 text-red-500 text-sm font-semibold hidden">
            <!-- Mensaje guía para el usuario -->
            Error de conexión. Por favor, verifica tus Reglas de Seguridad de Firebase Firestore (Ver código fuente).
        </div>
        <!-- Contenedor para la guía de reglas de seguridad -->
        <div id="rules-guide" class="text-center mt-4 text-xs text-gray-600 hidden">
            Para solucionar los errores de conexión, **DEBES** establecer las siguientes Reglas de Seguridad en tu consola de Firebase Firestore, bajo la pestaña "Rules" (Hacer clic en "Publish" después de pegar):
            <pre class="bg-gray-100 p-2 mt-1 rounded-lg text-left inline-block">
service cloud.firestore {
  match /databases/{database}/documents {
    // Permite la lectura y escritura total para fines de prueba/despliegue
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
</pre>
        </div>
    </footer>

    <!-- Script de Firebase (Lógica del app) y Arrastre/Zoom -->
    <script>
        // Establecer nivel de log para depuración de Firebase
        if (typeof firebase !== 'undefined' && firebase.firestore) {
            firebase.firestore.setLogLevel('debug');
        } else {
            console.warn("Firebase no cargado completamente al intentar establecer el nivel de log.");
        }

        // Configuración de Firebase estática proporcionada por el usuario (la única fuente de verdad)
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBp7dwu61R7_ZDjmcSUGG7Rg3HtYAAa_uE",
            authDomain: "maestro-del-mes.firebaseapp.com",
            projectId: "maestro-del-mes",
            storageBucket: "maestro-del-mes.firebasestorage.app",
            messagingSenderId: "983522163635",
            appId: "1:983522163635:web:17ce02eb9e8fa7ea1e69c6"
        };
        
        let app, db, auth;
        let adminMode = false; // Estado del modo edición

        // Estado global para el arrastre y zoom
        let isDragging = false;
        let dragTarget = null;
        let startX = 0; // Nueva variable para arrastre horizontal
        let startY = 0;
        let startTransform = { scale: 100, offsetX: 0, offsetY: 0 }; // Escala en %, Desplazamiento X e Y en px

        // Definición de los ciclos con nombres simplificados para los encabezados de las tarjetas
        const CYCLES = [
            { id: 'Inicial_Primer_Ciclo', name: 'Inicial' }, 
            { id: 'Primaria_Primer_Ciclo', name: 'Primaria' }, 
            { id: 'Secundaria_Primer_Ciclo', name: 'Secundaria' }, 
            { id: 'Primaria_Segundo_Ciclo', name: 'Primaria' }, 
            { id: 'Inicial_Segundo_Ciclo', name: 'Inicial' } 
        ];
        
        // --- FUNCIONES DE UTILIDAD DE UI ---

        // Lógica para ajustar el ancho de "MAESTRO DEL MES"
        function matchLogoWidths() {
            try {
                const pinceladasEl = document.querySelector('.text-pinceladas');
                const calificacionesEl = document.querySelector('.text-calificaciones');
                if (pinceladasEl && calificacionesEl) {
                    calificacionesEl.style.width = `${pinceladasEl.offsetWidth}px`;
                }
            } catch (error) {
                console.error("Error al ajustar el ancho del texto 'MAESTRO DEL MES':", error);
            }
        }
        
        // Función para cambiar el modo de administración (mostrar/ocultar inputs)
        window.toggleAdminMode = function() {
            adminMode = !adminMode;
            const adminControls = document.querySelectorAll('.admin-controls');
            const imageWrappers = document.querySelectorAll('.image-placeholder-wrapper');
            
            adminControls.forEach(el => {
                el.classList.toggle('hidden', !adminMode);
            });

            // Cambiar el cursor de las imágenes a 'grab' solo en modo admin
            imageWrappers.forEach(el => {
                el.classList.toggle('admin-mode-drag', adminMode);
            });

            // Mostrar u ocultar la guía de reglas si el modo admin está activo
            document.getElementById('rules-guide').classList.toggle('hidden', !adminMode);
            
            console.log(`Modo Admin: ${adminMode ? 'ACTIVADO' : 'DESACTIVADO'}`);
        };

        // --- MANEJO DE IMAGEN: DRAG AND ZOOM ---

        // Función auxiliar para obtener la transformación actual de la imagen
        function getCurrentTransform(element) {
            const style = window.getComputedStyle(element);
            const transform = style.transform;
            let scale = 1;
            let offsetX = 0; // Agregado desplazamiento X
            let offsetY = 0;

            if (transform && transform !== 'none') {
                const matrix = transform.match(/matrix.*\((.+)\)/);
                if (matrix) {
                    const values = matrix[1].split(', ').map(parseFloat);
                    scale = values[0];
                    offsetX = values[4]; // Índice 4 para translateX
                    offsetY = values[5]; // Índice 5 para translateY
                }
            }
            return { scale: scale * 100, offsetX: offsetX, offsetY: offsetY }; 
        }

        // Inicia el arrastre
        function startDrag(event, cycleId) {
            dragTarget = document.getElementById(`img-${cycleId}`);
            if (!adminMode || !dragTarget || dragTarget.classList.contains('hidden')) return;
            
            event.preventDefault(); 
            isDragging = true;
            
            // Obtener la posición inicial (mouse o touch)
            startX = event.clientX || event.touches[0].clientX; // Capturar posición X inicial
            startY = event.clientY || event.touches[0].clientY; 

            // Obtener la escala y offset actuales
            const current = getCurrentTransform(dragTarget);
            startTransform.scale = current.scale;
            startTransform.offsetX = current.offsetX; // Capturar offset X inicial
            startTransform.offsetY = current.offsetY;
            
            dragTarget.parentElement.style.cursor = 'grabbing';

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDrag);
            document.addEventListener('touchend', endDrag);
        }

        // Se ejecuta durante el arrastre
        function onDrag(event) {
            if (!isDragging || !dragTarget) return;

            const currentX = event.clientX || event.touches[0].clientX;
            const currentY = event.clientY || event.touches[0].clientY;
            const deltaX = currentX - startX; // Diferencia total del mouse/dedo en X
            const deltaY = currentY - startY; // Diferencia total del mouse/dedo en Y
            
            const wrapperWidth = dragTarget.parentElement.offsetWidth; // Ancho del contenedor
            const wrapperHeight = dragTarget.parentElement.offsetHeight; // Altura del contenedor
            const currentScale = startTransform.scale / 100;
            
            // Altura y Ancho de la imagen ampliada
            const scaledWidth = wrapperWidth * currentScale;
            const scaledHeight = wrapperHeight * currentScale;
            
            // Espacio fuera del contenedor (solo vertical y horizontal)
            const overflowX = (scaledWidth - wrapperWidth) / 2;
            const overflowY = (scaledHeight - wrapperHeight) / 2;

            // Calcular los nuevos desplazamientos X e Y
            let newOffsetX = startTransform.offsetX + deltaX;
            let newOffsetY = startTransform.offsetY + deltaY;
            
            if (currentScale > 1) {
                // Límites de desplazamiento X
                newOffsetX = Math.max(-overflowX, Math.min(overflowX, newOffsetX));
                // Límites de desplazamiento Y
                newOffsetY = Math.max(-overflowY, Math.min(overflowY, newOffsetY));
            } else {
                // Si no hay zoom, no se puede mover
                newOffsetX = 0;
                newOffsetY = 0;
            }

            // Aplicar la nueva transformación (usando translate(X, Y))
            dragTarget.style.transform = `scale(${currentScale}) translate(${newOffsetX}px, ${newOffsetY}px)`;
        }

        // Finaliza el arrastre
        function endDrag() {
            if (!isDragging || !dragTarget) return;

            isDragging = false;
            dragTarget.parentElement.style.cursor = 'grab';

            // Al finalizar, actualizar los inputs ocultos
            const cycleId = dragTarget.id.replace('img-', '');
            const offsetInputX = document.getElementById(`offset-input-x-${cycleId}`);
            const offsetInputY = document.getElementById(`offset-input-y-${cycleId}`);
            if (offsetInputX && offsetInputY) {
                const current = getCurrentTransform(dragTarget);
                offsetInputX.value = current.offsetX; // Guardar offset X
                offsetInputY.value = current.offsetY; // Guardar offset Y
            }
            dragTarget = null;

            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', endDrag);
        }

        // Maneja el zoom al cambiar el slider
        window.handleZoom = function(cycleId, sliderElement) {
            const scale = sliderElement.value / 100; // Valor entre 1.0 y 3.0
            const imgElement = document.getElementById(`img-${cycleId}`);
            const scaleInput = document.getElementById(`scale-input-${cycleId}`);
            const offsetInputX = document.getElementById(`offset-input-x-${cycleId}`);
            const offsetInputY = document.getElementById(`offset-input-y-${cycleId}`);

            if (!imgElement || imgElement.classList.contains('hidden')) return;

            // Obtener el offset X e Y actuales
            const current = getCurrentTransform(imgElement);
            let currentOffsetX = current.offsetX;
            let currentOffsetY = current.offsetY;

            // Aplicar el nuevo zoom y mantener el offset X e Y.
            imgElement.style.transform = `scale(${scale}) translate(${currentOffsetX}px, ${currentOffsetY}px)`;

            // Actualizar inputs ocultos para guardar
            scaleInput.value = scale;
            
            // Si reducimos el zoom a 100%, el offset debe ser 0.
            if (scale === 1) {
                offsetInputX.value = 0;
                offsetInputY.value = 0;
                imgElement.style.transform = `scale(1) translate(0px, 0px)`;
            } else {
                 offsetInputX.value = currentOffsetX;
                 offsetInputY.value = currentOffsetY; 
            }
        };


        // --- FUNCIONES DE FIRESTORE Y SETUP ---

        // Función de inicialización de Firebase y autenticación
        async function initializeFirebase() {
            try {
                // Usamos la configuración estática que el usuario proporcionó
                app = firebase.initializeApp(FIREBASE_CONFIG);
                db = app.firestore(); 
                auth = app.auth();     

                // Autenticación anónima para leer/escribir (NECESARIO PARA PERSISTENCIA)
                await auth.signInAnonymously();

                auth.onAuthStateChanged((user) => {
                    if (user) {
                        console.log("Usuario autenticado anónimamente. UID:", user.uid);
                        setupUIAndListeners(); 
                    } else {
                        console.log("Error: No se pudo autenticar al usuario.");
                        document.getElementById('error-message').textContent = "Error: La aplicación no pudo conectarse a la base de datos.";
                        document.getElementById('error-message').classList.remove('hidden');
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                document.getElementById('error-message').textContent = `Error crítico de conexión: ${error.message}. Verifica las Reglas de Seguridad de Firestore.`;
                document.getElementById('error-message').classList.remove('hidden');
            }
        }

        // FUNCIÓN CLAVE: La ruta es simple y pública para el funcionamiento en Google Sites/GitHub
        function getCycleDocRef(cycleId) {
            return db.collection('teacher_of_the_month').doc(cycleId);
        }

        /**
         * Renderiza la estructura de la tarjeta en el DOM.
         */
        function renderCardStructure(cycle) {
            const container = document.getElementById('cards-container');
            
            const cardHtml = `
                <div id="card-${cycle.id}" class="card-container bg-gray-50 p-2 rounded-xl shadow-xl border border-gray-100 flex flex-col items-center">
                    
                    <!-- Nombre de sección simplificado (Inicial, Primaria, Secundaria) -->
                    <h2 class="text-base font-bold text-indigo-700 mb-0.5 pt-1 pb-1 text-center truncate w-full">${cycle.name}</h2>
                    
                    <!-- Contenedor para la imagen con eventos de arrastre -->
                    <div id="wrapper-${cycle.id}" 
                         class="image-placeholder-wrapper shadow-lg"
                         onmousedown="startDrag(event, '${cycle.id}')"
                         ontouchstart="startDrag(event, '${cycle.id}')">
                        <!-- Texto COMING SOON (Visible por defecto) -->
                        <span id="coming-soon-${cycle.id}" class="coming-soon-text">COMING SOON</span>

                        <!-- Imagen real (Oculta si no hay URL válida) -->
                        <img id="img-${cycle.id}" 
                             src="" 
                             alt="Maestro del Mes ${cycle.name}" 
                             class="actual-image hidden">
                    </div>

                    <!-- Información del Maestro (Visible en modo normal) -->
                    <div class="mt-2 w-full text-center">
                        <h3 id="name-${cycle.id}" class="text-sm font-extrabold text-gray-800 truncate mb-0.5"></h3>
                        <p id="desc-${cycle.id}" class="text-xs text-gray-500 italic break-words"></p>
                    </div>

                    <!-- Controles de Administración Ocultos -->
                    <div id="controls-${cycle.id}" class="admin-controls hidden w-full mt-2 pt-2 border-t border-gray-200">
                        <!-- Control de Zoom -->
                        <div class="mb-2">
                             <label for="zoom-slider-${cycle.id}" class="text-xs text-gray-700 block mb-1">Zoom (Arrastrar imagen para mover)</label>
                             <input type="range" id="zoom-slider-${cycle.id}" min="100" max="300" value="100" step="10" 
                                class="zoom-slider" 
                                oninput="handleZoom('${cycle.id}', this)">
                        </div>
                        
                        <!-- Campos de Edición -->
                        <input type="text" id="name-input-${cycle.id}" placeholder="Nombre del Maestro" class="w-full p-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-1 text-xs">
                        <textarea id="desc-input-${cycle.id}" placeholder="Frase o reconocimiento (máx. 100 caracteres)" maxlength="100" class="w-full p-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-1 text-xs resize-none h-10"></textarea>
                        <input type="url" id="input-${cycle.id}" placeholder="Pega URL de imagen vertical aquí" class="w-full p-1 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-1 text-xs">
                        
                        <!-- Campos ocultos para guardar la posición de arrastre y zoom de la imagen -->
                        <input type="hidden" id="scale-input-${cycle.id}" value="1">
                        <input type="hidden" id="offset-input-x-${cycle.id}" value="0"> <!-- NUEVO offset X -->
                        <input type="hidden" id="offset-input-y-${cycle.id}" value="0"> <!-- offset Y -->

                        <button id="btn-${cycle.id}" class="w-full bg-indigo-600 text-white font-semibold py-1 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md text-xs" onclick="updateContent('${cycle.id}')">
                            Guardar Contenido
                        </button>
                        <p class="text-[10px] text-gray-500 mt-1 text-center" id="status-${cycle.id}"></p>
                    </div>
                </div>
            `;
            container.innerHTML += cardHtml;
        }

        /**
         * Escucha los cambios en la base de datos para actualizar la imagen y el texto en la UI.
         */
        function listenForUpdates(cycle) {
            const docRef = getCycleDocRef(cycle.id);
            
            docRef.onSnapshot((docSnap) => {
                
                const imgElement = document.getElementById(`img-${cycle.id}`);
                const soonElement = document.getElementById(`coming-soon-${cycle.id}`);
                const nameElement = document.getElementById(`name-${cycle.id}`);
                const descElement = document.getElementById(`desc-${cycle.id}`);
                
                const nameInputElement = document.getElementById(`name-input-${cycle.id}`);
                const descInputElement = document.getElementById(`desc-input-${cycle.id}`);
                const urlInputElement = document.getElementById(`input-${cycle.id}`);
                const scaleInputElement = document.getElementById(`scale-input-${cycle.id}`);
                const offsetInputXElement = document.getElementById(`offset-input-x-${cycle.id}`);
                const offsetInputYElement = document.getElementById(`offset-input-y-${cycle.id}`);
                const zoomSliderElement = document.getElementById(`zoom-slider-${cycle.id}`);
                
                let imageUrl = '';
                let teacherName = '';
                let description = '';
                let imageScale = '1'; 
                let imageOffsetX = '0'; // Desplazamiento X
                let imageOffsetY = '0'; // Desplazamiento Y

                if (docSnap.exists) {
                    const data = docSnap.data();
                    imageUrl = data.imageUrl || '';
                    teacherName = data.teacherName || '';
                    description = data.description || '';
                    imageScale = data.imageScale || '1'; 
                    imageOffsetX = data.imageOffsetX || '0'; // Cargar X
                    imageOffsetY = data.imageOffsetY || '0'; // Cargar Y
                } else {
                    docRef.set({ imageUrl: '', teacherName: '', description: '', cycleId: cycle.id, imageScale: imageScale, imageOffsetX: imageOffsetX, imageOffsetY: imageOffsetY }, { merge: true }).catch(err => {
                        console.error("Error al inicializar el documento:", err);
                    });
                }

                // 1. Manejo estable del Placeholder / Imagen
                if (imageUrl) {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                         imgElement.src = imageUrl;
                         // Aplicar transformación guardada (Zoom + Posición X e Y)
                         imgElement.style.transform = `scale(${imageScale}) translate(${imageOffsetX}px, ${imageOffsetY}px)`; 
                         imgElement.classList.remove('hidden');
                         soonElement.classList.add('hidden');
                    };
                    tempImg.onerror = () => {
                         imgElement.classList.add('hidden');
                         soonElement.classList.remove('hidden');
                    };
                    tempImg.src = imageUrl;
                } else {
                    imgElement.classList.add('hidden');
                    soonElement.classList.remove('hidden');
                    // Resetear transformación si no hay imagen
                    imgElement.style.transform = `scale(1) translate(0px, 0px)`;
                }

                // 2. Actualizar texto de Maestro y Descripción (Vista Pública)
                nameElement.textContent = teacherName || '—';
                descElement.textContent = description || '';
                
                // 3. Rellenar campos del Administrador (Modo Edición)
                nameInputElement.value = teacherName;
                descInputElement.value = description;
                urlInputElement.value = imageUrl;
                scaleInputElement.value = imageScale;
                offsetInputXElement.value = imageOffsetX; 
                offsetInputYElement.value = imageOffsetY; 
                zoomSliderElement.value = parseFloat(imageScale) * 100; // El slider usa valor 100-300
                
            }, (error) => {
                console.error("Error al escuchar cambios en Firestore:", error);
                // Si hay un error, ocultamos la guía de reglas para no estorbar
                document.getElementById('rules-guide').classList.remove('hidden'); // Mostrar guía de reglas
                document.getElementById('error-message').textContent = "Error de conexión en tiempo real: Permisos insuficientes. **DEBES** Publicar las Reglas de Seguridad en Firebase (ver abajo).";
                document.getElementById('error-message').classList.remove('hidden');
            });
        }

        /**
         * Maneja el clic del botón y actualiza todos los campos en Firestore.
         */
        window.updateContent = async function(cycleId) {
            if (!db) {
                console.error("Firestore no está inicializado.");
                return;
            }

            const nameInput = document.getElementById(`name-input-${cycleId}`);
            const descInput = document.getElementById(`desc-input-${cycleId}`);
            const urlInput = document.getElementById(`input-${cycleId}`);
            const scaleInput = document.getElementById(`scale-input-${cycleId}`);
            const offsetInputX = document.getElementById(`offset-input-x-${cycleId}`);
            const offsetInputY = document.getElementById(`offset-input-y-${cycleId}`);
            const statusElement = document.getElementById(`status-${cycleId}`);
            
            const teacherName = nameInput.value.trim();
            const description = descInput.value.trim();
            const imageUrl = urlInput.value.trim();
            const imageScale = scaleInput.value;
            const imageOffsetX = offsetInputX.value;
            const imageOffsetY = offsetInputY.value;

            if (!imageUrl && !teacherName && !description) {
                statusElement.textContent = "Ingresa al menos un valor para guardar.";
                return;
            }
            
            statusElement.textContent = "Guardando...";
            const docRef = getCycleDocRef(cycleId);
            
            try {
                await docRef.set({ 
                    imageUrl: imageUrl, 
                    teacherName: teacherName,
                    description: description,
                    imageScale: imageScale, 
                    imageOffsetX: imageOffsetX, // Guardar X
                    imageOffsetY: imageOffsetY, // Guardar Y
                    lastUpdated: new Date().toISOString() 
                }, { merge: true });
                
                statusElement.textContent = "¡Contenido guardado con éxito!";

            } catch (error) {
                console.error("Error al actualizar el contenido:", error);
                statusElement.textContent = `Error al guardar: ${error.message}`;
            }
        };

        // Configuración inicial: Renderizar UI y establecer listeners de datos
        function setupUIAndListeners() {
            CYCLES.forEach(cycle => {
                renderCardStructure(cycle);
                listenForUpdates(cycle);
            });
            matchLogoWidths();
            window.addEventListener('resize', matchLogoWidths);
        }

        // Llamamos a la inicialización de Firebase al cargar el contenido del DOM
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
