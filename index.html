<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro del Mes</title>
    <!-- Fuentes personalizadas -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chewy&family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        chewy: ['Chewy', 'cursive'],
                        montserrat: ['Montserrat', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- Firebase SDKs v8 (como en la versión original) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Estilos personalizados -->
    <style>
        :root {
            --logo-blue: #1A2C59; 
            --logo-red: #E02B20; 
        }
        body {
            background-color: white; 
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem; 
        }
        .logo-link { text-decoration: none; color: inherit; display: inline-block; }
        .text-colegio { color: var(--logo-blue); font-family: 'Montserrat', sans-serif; font-size: clamp(1rem, 3vw, 1.2rem); font-weight: 700; letter-spacing: 1px; margin-bottom: -8px; }
        .text-pinceladas { font-family: 'Chewy', cursive; color: var(--logo-red); font-size: clamp(2.5rem, 8vw, 3.5rem); line-height: 1; }
        .text-calificaciones { background-color: var(--logo-blue); color: #ffffff; padding: 4px 8px; border-radius: 50px; font-family: 'Montserrat', sans-serif; font-size: clamp(1rem, 3vw, 1.2rem); font-weight: 700; display: flex; justify-content: center; align-items: center; margin-top: -3px; letter-spacing: 2px; text-align: center; }
        header { margin-bottom: 3vh; } /* Reducido */
        .card-container {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 17%; /* Reducido */
            flex-shrink: 0; 
        }
        .card-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px -10px rgba(0, 0, 0, 0.15); 
        }
        .image-placeholder-wrapper {
            width: 100%;
            padding-top: 125%; /* Ratio 4:5 */
            background-color: #e2e8f0;
            border-radius: 0.75rem; 
            position: relative;
            overflow: hidden;
            cursor: default;
        }
        .admin-mode-drag { cursor: grab; }
        .admin-mode-drag:active { cursor: grabbing; }
        .placeholder-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem; font-weight: 600; color: #64748b;
            text-align: center; z-index: 1;
        }
        .actual-image {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            transform-origin: center center;
        }
        .zoom-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; outline: none; opacity: 0.8; transition: opacity .2s;
        }
        .zoom-slider:hover { opacity: 1; }
        .zoom-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--logo-blue); cursor: pointer; }
        
        #cards-container {
            display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: center; align-items: flex-start; gap: 1rem; /* Reducido */
        }
        #card-Secundaria_Primer_Ciclo { margin-top: 0; }
        #card-Primaria_Primer_Ciclo, #card-Primaria_Segundo_Ciclo { margin-top: 2.5vh; } /* Reducido */
        #card-Inicial_Primer_Ciclo, #card-Inicial_Segundo_Ciclo { margin-top: 5vh; } /* Reducido */
        
        @media (max-width: 1024px) {
            header { margin-bottom: 2rem; }
            #cards-container { flex-wrap: wrap; gap: 1.5rem; justify-content: center; }
            .card-container { width: 45%; margin-top: 0 !important; }
        }
        @media (max-width: 640px) {
            .card-container { width: 90%; }
        }
    </style>
</head>
<body>

    <header class="text-center py-4 w-full max-w-7xl">
        <a href="#" class="logo-link" id="logo-link">
            <div class="inline-block">
                <div class="text-colegio">COLEGIO</div>
                <div class="text-pinceladas">Pinceladas</div>
                <div class="text-calificaciones">MAESTRO DEL MES</div>
            </div>
        </a>
    </header>

    <main class="w-full max-w-7xl mx-auto px-2 pb-6 flex-grow">
        <div id="cards-container">
            <!-- Las tarjetas se generan dinámicamente -->
        </div>
    </main>
    
    <footer class="w-full text-center py-4">
        <div id="status-message" class="text-center mt-2 text-sm font-semibold text-gray-600"></div>
    </footer>

    <script>
        // --- CONFIGURACIÓN ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBp7dwu61R7_ZDjmcSUGG7Rg3HtYAAa_uE",
            authDomain: "maestro-del-mes.firebaseapp.com",
            projectId: "maestro-del-mes",
            storageBucket: "maestro-del-mes.firebasestorage.app",
            messagingSenderId: "983522163635",
            appId: "1:983522163635:web:17ce02eb9e8fa7ea1e69c6"
        };
        
        const CYCLES = [
            { id: 'Inicial_Primer_Ciclo', name: 'Inicial' }, 
            { id: 'Primaria_Primer_Ciclo', name: 'Primaria' }, 
            { id: 'Secundaria_Primer_Ciclo', name: 'Secundaria' }, 
            { id: 'Primaria_Segundo_Ciclo', name: 'Primaria' }, 
            { id: 'Inicial_Segundo_Ciclo', name: 'Inicial' } 
        ];

        // --- OPTIMIZACIÓN: Lógica encapsulada para mayor estabilidad ---
        const App = {
            db: null,
            auth: null,
            adminMode: false,
            dragState: {
                isDragging: false,
                target: null,
                startX: 0,
                startY: 0,
                startOffsetX: 0,
                startOffsetY: 0
            },

            // 1. INICIALIZACIÓN (Lógica original v8)
            async init() {
                try {
                    const app = firebase.initializeApp(FIREBASE_CONFIG);
                    this.auth = app.auth();
                    this.db = app.firestore();
                    
                    document.getElementById('status-message').textContent = 'Conectando...';
                    
                    await this.auth.signInAnonymously();

                    this.auth.onAuthStateChanged((user) => {
                        if (user) {
                            console.log("Autenticación anónima exitosa. UID:", user.uid);
                            document.getElementById('status-message').textContent = ''; // Se elimina el mensaje
                            this.setupUI();
                            this.attachListeners();
                        } else {
                           throw new Error("El usuario no pudo ser autenticado.");
                        }
                    });
                } catch (error) {
                    console.error("Error crítico de Firebase:", error);
                    document.getElementById('status-message').textContent = `Error: ${error.message}.`;
                }
            },

            // 2. CONSTRUCCIÓN DE LA INTERFAZ
            setupUI() {
                const container = document.getElementById('cards-container');
                container.innerHTML = '';
                CYCLES.forEach(cycle => {
                    const card = this.createCardElement(cycle);
                    container.appendChild(card);
                    this.listenToDoc(cycle.id);
                });
                this.adjustLogoWidth();
            },

            createCardElement(cycle) {
                const card = document.createElement('div');
                card.id = `card-${cycle.id}`;
                card.className = "card-container bg-white p-2 rounded-xl shadow-lg border border-gray-200 flex flex-col items-center";
                
                card.innerHTML = `
                    <h2 class="text-base font-bold text-indigo-800 mb-1.5 text-center">${cycle.name}</h2>
                    <div id="wrapper-${cycle.id}" class="image-placeholder-wrapper shadow-inner">
                        <span class="placeholder-text">SIN IMAGEN</span>
                        <img id="img-${cycle.id}" class="actual-image hidden" alt="Maestro del Mes ${cycle.name}">
                    </div>
                    <div class="mt-2 w-full text-center">
                        <h3 id="name-${cycle.id}" class="text-sm font-extrabold text-gray-900 truncate"></h3>
                        <p id="desc-${cycle.id}" class="text-xs text-gray-600 italic break-words h-10"></p>
                    </div>
                    <div id="controls-${cycle.id}" class="admin-controls hidden w-full mt-2 pt-2 border-t border-gray-200 space-y-2">
                        <input type="url" id="url-input-${cycle.id}" placeholder="Pega URL de la imagen aquí" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                        <div>
                             <label class="text-xs font-semibold text-gray-700 block mb-1">Ajusta el zoom y la posición</label>
                             <input type="range" id="zoom-slider-${cycle.id}" min="100" max="300" value="100" class="zoom-slider">
                        </div>
                        <input type="text" id="name-input-${cycle.id}" placeholder="Nombre del Maestro" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                        <textarea id="desc-input-${cycle.id}" placeholder="Frase o reconocimiento" maxlength="100" class="w-full p-2 border border-gray-300 rounded-lg text-sm resize-none h-14"></textarea>
                        <button id="btn-${cycle.id}" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 transition shadow-md text-sm">
                            Guardar Cambios
                        </button>
                        <p class="text-xs text-gray-500 mt-1 text-center" id="save-status-${cycle.id}"></p>
                    </div>
                `;
                return card;
            },

            // 3. MANEJO DE EVENTOS
            attachListeners() {
                document.getElementById('logo-link').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.toggleAdminMode();
                });
                window.addEventListener('resize', () => this.adjustLogoWidth());
                
                const container = document.getElementById('cards-container');
                container.addEventListener('mousedown', e => this.startDrag(e));
                container.addEventListener('touchstart', e => this.startDrag(e), { passive: false });
                document.addEventListener('mousemove', e => this.onDrag(e));
                document.addEventListener('touchmove', e => this.onDrag(e), { passive: false });
                document.addEventListener('mouseup', () => this.endDrag());
                document.addEventListener('touchend', () => this.endDrag());

                container.addEventListener('input', e => {
                    if (e.target.matches('.zoom-slider')) this.handleZoom(e.target);
                });
                container.addEventListener('click', e => {
                    if (e.target.matches('button')) this.saveChanges(e.target.id.replace('btn-', ''));
                });
            },

            // 4. LÓGICA DE DATOS (FIRESTORE v8)
            listenToDoc(cycleId) {
                const docRef = this.db.collection('teacher_of_the_month').doc(cycleId);
                docRef.onSnapshot((docSnap) => {
                    const data = docSnap.exists ? docSnap.data() : {};
                    this.updateCardUI(cycleId, data);
                }, (error) => {
                    console.error(`Error escuchando ${cycleId}:`, error);
                    document.getElementById('status-message').textContent = "Error de permisos en Firestore.";
                });
            },

            updateCardUI(cycleId, data) {
                const nameEl = document.getElementById(`name-${cycleId}`);
                const descEl = document.getElementById(`desc-${cycleId}`);
                const imgEl = document.getElementById(`img-${cycleId}`);
                const placeholderEl = imgEl.previousElementSibling;

                nameEl.textContent = data.teacherName || '—';
                descEl.textContent = data.description || '';

                if (data.imageUrl) {
                    const tempImg = new Image();
                    tempImg.onload = () => {
                        imgEl.src = data.imageUrl;
                        imgEl.style.transform = `scale(${data.imageScale || 1}) translate(${data.imageOffsetX || 0}px, ${data.imageOffsetY || 0}px)`;
                        imgEl.classList.remove('hidden');
                        placeholderEl.classList.add('hidden');
                    };
                    tempImg.onerror = () => {
                        imgEl.classList.add('hidden');
                        placeholderEl.classList.remove('hidden');
                    };
                    tempImg.src = data.imageUrl;
                } else {
                    imgEl.classList.add('hidden');
                    placeholderEl.classList.remove('hidden');
                }

                document.getElementById(`name-input-${cycleId}`).value = data.teacherName || '';
                document.getElementById(`desc-input-${cycleId}`).value = data.description || '';
                document.getElementById(`url-input-${cycleId}`).value = data.imageUrl || '';
                document.getElementById(`zoom-slider-${cycleId}`).value = (data.imageScale || 1) * 100;
            },
            
            async saveChanges(cycleId) {
                const statusEl = document.getElementById(`save-status-${cycleId}`);
                statusEl.textContent = 'Guardando...';

                const teacherName = document.getElementById(`name-input-${cycleId}`).value.trim();
                const description = document.getElementById(`desc-input-${cycleId}`).value.trim();
                const imageUrl = document.getElementById(`url-input-${cycleId}`).value.trim();
                const imageScale = document.getElementById(`zoom-slider-${cycleId}`).value / 100;

                const imgEl = document.getElementById(`img-${cycleId}`);
                const transform = this.parseTransform(imgEl.style.transform);

                const dataToSave = {
                    teacherName, description, imageUrl, imageScale,
                    imageOffsetX: transform.offsetX,
                    imageOffsetY: transform.offsetY,
                    lastUpdated: new Date().toISOString()
                };
                
                try {
                    const docRef = this.db.collection('teacher_of_the_month').doc(cycleId);
                    await docRef.set(dataToSave, { merge: true });
                    statusEl.textContent = '¡Guardado con éxito!';
                    setTimeout(() => statusEl.textContent = '', 3000);
                } catch(error) {
                    console.error("Error al guardar en Firestore:", error);
                    statusEl.textContent = `Error: ${error.message}`;
                }
            },

            // 5. LÓGICA DE INTERACCIÓN
            toggleAdminMode() {
                this.adminMode = !this.adminMode;
                document.querySelectorAll('.admin-controls').forEach(el => el.classList.toggle('hidden', !this.adminMode));
                document.querySelectorAll('.image-placeholder-wrapper').forEach(el => el.classList.toggle('admin-mode-drag', this.adminMode));
                document.getElementById('status-message').textContent = '';
            },
            
            handleZoom(slider) {
                const cycleId = slider.id.replace('zoom-slider-', '');
                const imgEl = document.getElementById(`img-${cycleId}`);
                const scale = slider.value / 100;
                const currentTransform = this.parseTransform(imgEl.style.transform);
                imgEl.style.transform = `scale(${scale}) translate(${currentTransform.offsetX}px, ${currentTransform.offsetY}px)`;
            },

            startDrag(event) {
                if (!this.adminMode) return;
                const wrapper = event.target.closest('.image-placeholder-wrapper');
                if (!wrapper) return;
                
                const img = wrapper.querySelector('.actual-image');
                if (!img || img.classList.contains('hidden')) return;

                event.preventDefault();
                
                this.dragState = {
                    isDragging: true,
                    target: img,
                    startX: event.clientX || event.touches[0].clientX,
                    startY: event.clientY || event.touches[0].clientY,
                    ...this.parseTransform(img.style.transform)
                };
                this.dragState.startOffsetX = this.dragState.offsetX;
                this.dragState.startOffsetY = this.dragState.offsetY;
            },

            onDrag(event) {
                if (!this.dragState.isDragging) return;
                
                const clientX = event.clientX || event.touches[0].clientX;
                const clientY = event.clientY || event.touches[0].clientY;
                const deltaX = clientX - this.dragState.startX;
                const deltaY = clientY - this.dragState.startY;

                const newOffsetX = this.dragState.startOffsetX + deltaX;
                const newOffsetY = this.dragState.startOffsetY + deltaY;
                
                this.dragState.target.style.transform = `scale(${this.dragState.scale}) translate(${newOffsetX}px, ${newOffsetY}px)`;
            },
            
            endDrag() {
                this.dragState.isDragging = false;
            },

            // 6. FUNCIONES DE UTILIDAD
            adjustLogoWidth() {
                const pinceladasEl = document.querySelector('.text-pinceladas');
                const calificacionesEl = document.querySelector('.text-calificaciones');
                if (pinceladasEl && calificacionesEl) {
                    calificacionesEl.style.width = `${pinceladasEl.offsetWidth + 4}px`;
                }
            },
            
            parseTransform(transformStr) {
                if (!transformStr) return { scale: 1, offsetX: 0, offsetY: 0 };
                const scaleMatch = transformStr.match(/scale\(([^)]+)\)/);
                const translateMatch = transformStr.match(/translate\(([^,]+)px, ([^)]+)px\)/);
                return {
                    scale: scaleMatch ? parseFloat(scaleMatch[1]) : 1,
                    offsetX: translateMatch ? parseFloat(translateMatch[1]) : 0,
                    offsetY: translateMatch ? parseFloat(translateMatch[2]) : 0
                };
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>

